
import React, { useState } from "react";
import axios from "axios";

const CombinedForm = () => {
  // ===== Basic Info State =====
  const [formData, setFormData] = useState({
    caseId: "",
    caseName: "",
    dateOfAssessment: "",
    workerName: "",
    personId: "",
    memberName: "",
    memberDob: "",
    memberRole: "",
  });

  // ===== Concrete Supports State =====
  const [isOpen, setIsOpen] = useState(null);
  const [hoveredRow, setHoveredRow] = useState(null);
  const [tooltipPosition, setTooltipPosition] = useState({ x: 0, y: 0 });
  const [concreteData, setConcreteData] = useState({});

  // ===== Dynamic Sections =====
  const sections = [
    {
      id: 1,
      title: "Identification and Use of Concrete Supports in Times of Need",
      rows: [
        { id: 105, title: "Involvement with Care", help: "Measures how engaged and cooperative the caregiver is with the care process." },
        { id: 106, title: "Parent/Caregiver‚Äôs Knowledge of Rights and Responsibilities", help: "Assesses understanding of rights, duties, and legal obligations as a caregiver." },
        { id: 107, title: "Financial Status", help: "Examines stability of income, budgeting, and ability to meet basic needs." },
        { id: 108, title: "Organization", help: "Evaluates planning, scheduling, and ability to manage tasks effectively." },
        { id: 109, title: "Resources", help: "Checks access to concrete supports such as food, housing, transportation, etc." },
        { id: 110, title: "Knowledge of Social Service Options", help: "Determines awareness and understanding of available support services." },
        { id: 111, title: "Residential Stability", help: "Assesses consistency and security of the living situation." },
        { id: 112, title: "Job Functioning", help: "Evaluates employment stability, job performance, and ability to sustain work." },
        { id: 113, title: "Social Support", help: "Measures the availability and quality of support from friends, family, and community." },
      ],
    },
    {
      id: 2,
      title: "Fire and Burn Safety",
      rows: [
        { id: 201, title: "Presence of Smoke Detectors", help: "Determines if smoke alarms are installed and functional." },
        { id: 202, title: "Emergency Exit Awareness", help: "Checks if family members know the evacuation plan." },
        { id: 203, title: "Child Safety Around Fire", help: "Assesses supervision and safety education for children regarding fire hazards." },
      ],
    },
    {
      id: 3,
      title: "Physical Environment Safety",
      rows: [
        { id: 301, title: "Cleanliness and Sanitation", help: "Evaluates hygiene and maintenance of the living environment." },
        { id: 302, title: "Structural Safety", help: "Assesses home structure for hazards like leaks or broken stairs." },
        { id: 303, title: "Electrical Safety", help: "Checks for exposed wiring or unsafe outlets." },
      ],
    },
  ];

  // ===== Handlers =====
  const handleChange = (e) => {
    setFormData({ ...formData, [e.target.name]: e.target.value });
  };

  const handleConcreteChange = (rowId, key, value) => {
    setConcreteData((prev) => ({
      ...prev,
      [rowId]: { ...prev[rowId], [key]: value },
    }));
  };

  // ===== Tooltip handlers =====
  const handleMouseEnter = (row) => setHoveredRow(row);
  const handleMouseLeave = () => setHoveredRow(null);
  const handleMouseMove = (e) => {
    setTooltipPosition({ x: e.pageX + 15, y: e.pageY + 15 });
  };

  // ===== Validation =====
  const isFormValid =
    formData.caseId.trim() !== "" &&
    formData.caseName.trim() !== "" &&
    formData.dateOfAssessment.trim() !== "" &&
    formData.workerName.trim() !== "";

  // ===== Submit Handler =====
  const handleSubmit = async (statusType) => {
    if (!isFormValid) {
      alert("‚ö†Ô∏è Please fill all required fields before saving!");
      return;
    }
    try {
      const payload = {
        ...formData,
        status: statusType,
        concreteSupports: concreteData,
      };
      await axios.post("http://localhost:5000/api/basic-info", payload);
      alert(`‚úÖ Data saved successfully as "${statusType}"!`);
      setFormData({
        caseId: "",
        caseName: "",
        dateOfAssessment: "",
        workerName: "",
        personId: "",
        memberName: "",
        memberDob: "",
        memberRole: "",
      });
      setConcreteData({});
    } catch (error) {
      console.error("‚ùå Error:", error);
      alert("Error saving data");
    }
  };

  // ===== UI =====
  return (
    <div
      style={{
        backgroundColor: "#f9f9f9",
        border: "1px solid #ddd",
        borderRadius: "10px",
        padding: "20px",
        maxWidth: "950px",
        margin: "40px auto",
        position: "relative",
      }}
    >
      <h3 style={{ borderBottom: "3px solid #007bff", paddingBottom: "5px" }}>
        Basic Information
      </h3>

      {/* === BASIC INFO FORM === */}
      <form onSubmit={(e) => e.preventDefault()} style={{ marginTop: "20px" }}>
        <div
          style={{
            display: "grid",
            gridTemplateColumns: "repeat(4, 1fr)",
            gap: "15px",
          }}
        >
          {[
            { label: "Case ID *", name: "caseId", type: "text" },
            { label: "Case Name *", name: "caseName", type: "text" },
            {
              label: "Date of Assessment *",
              name: "dateOfAssessment",
              type: "date",
              restrictToday: true, // üëà Only allow today's date
            },
            { label: "Worker Name *", name: "workerName", type: "text" },
            { label: "Person ID", name: "personId", type: "text" },
            { label: "Member Name", name: "memberName", type: "text" },
            { label: "Member Date of Birth", name: "memberDob", type: "date" },
            { label: "Member Role", name: "memberRole", type: "text" },
          ].map((field) => {
            const today = new Date().toISOString().split("T")[0]; // YYYY-MM-DD
            return (
              <div key={field.name}>
                <label>{field.label}</label>
                <input
                  type={field.type}
                  name={field.name}
                  value={formData[field.name]}
                  onChange={handleChange}
                  required={field.label.includes("*")}
                  {...(field.restrictToday && { min: today, max: today })}
                  style={{
                    border:
                      field.label.includes("*") && formData[field.name].trim() === ""
                        ? "1px solid red"
                        : "1px solid #ccc",
                    borderRadius: "5px",
                    padding: "5px",
                    width: "100%",
                  }}
                />
              </div>
            );
          })}
        </div>

        {/* === MULTIPLE DROPDOWN SECTIONS === */}
        {sections.map((section) => (
          <div key={section.id} style={{ marginTop: "40px" }}>
            <div
              onClick={() => setIsOpen(isOpen === section.id ? null : section.id)}
              style={{
                cursor: "pointer",
                display: "flex",
                alignItems: "center",
                justifyContent: "space-between",
                backgroundColor: "#9A98CA",
                color: "white",
                padding: "12px 18px",
                borderRadius: "5px",
                fontWeight: "bold",
                fontSize: "16px",
              }}
            >
              <span style={{ letterSpacing: "2px" }}>
                {isOpen === section.id ? "‚ñ≤" : "‚ñº"} {section.title}
              </span>
            </div>

            {isOpen === section.id && (
              <div style={{ marginTop: "25px", overflowX: "hidden" }}>
                <table style={{ width: "100%", borderCollapse: "collapse" }}>
                  <thead>
                    <tr style={{ backgroundColor: "#9A98CA", color: "white" }}>
                      <th style={thStyle}>Previous Score</th>
                      <th style={thStyle}>0</th>
                      <th style={thStyle}>1</th>
                      <th style={thStyle}>2</th>
                      <th style={thStyle}>3</th>
                      <th style={thStyle}>Unk</th>
                      <th style={thStyle}>N/A</th>
                      <th style={thStyle}>Factor</th>
                    </tr>
                  </thead>
                  <tbody>
                    {section.rows.map((row, index) => (
                      <tr
                        key={row.id}
                        style={{
                          backgroundColor: index % 2 !== 0 ? "#DFE6F8" : "white",
                          borderBottom: "1px solid #ccc",
                        }}
                      >
                        <td style={tdRadioStyle}></td>
                        {[0, 1, 2, 3].map((score) => (
                          <td key={score} style={tdRadioStyle}>
                            <input
                              type="radio"
                              name={`score-${section.id}-${row.id}`}
                              value={score}
                              checked={concreteData[row.id]?.score === score}
                              onChange={(e) =>
                                handleConcreteChange(row.id, "score", parseInt(e.target.value))
                              }
                            />
                          </td>
                        ))}
                        <td style={tdRadioStyle}></td>
                        <td style={tdRadioStyle}></td>
                        <td style={{ padding: "8px", width: "55%" }}>
                          <div style={{ color: "#333" }}>
                            <strong
                              onMouseEnter={() => handleMouseEnter(row)}
                              onMouseLeave={handleMouseLeave}
                              onMouseMove={handleMouseMove}
                              style={{ cursor: "help" }}
                            >
                              {row.id}. {row.title}
                            </strong>
                            <div style={{ marginTop: "6px" }}>
                              <label style={{ fontWeight: "bold" }}>Describe:</label>
                              <textarea
                                rows="2"
                                style={{
                                  width: "100%",
                                  borderRadius: "5px",
                                  border: "1px solid #ccc",
                                  padding: "5px",
                                  marginTop: "5px",
                                  resize: "vertical",
                                }}
                                value={concreteData[row.id]?.desc || ""}
                                onChange={(e) =>
                                  handleConcreteChange(row.id, "desc", e.target.value)
                                }
                              ></textarea>
                            </div>
                          </div>
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            )}
          </div>
        ))}

        {/* === ACTION BUTTONS === */}
        <div
          style={{
            display: "flex",
            gap: "15px",
            marginTop: "25px",
            justifyContent: "flex-end",
          }}
        >
          <button
            type="button"
            onClick={() => handleSubmit("Draft")}
            style={{
              ...buttonStyle("#6c757d"),
              opacity: isFormValid ? 1 : 0.6,
              cursor: isFormValid ? "pointer" : "not-allowed",
            }}
            disabled={!isFormValid}
          >
            Save as Draft
          </button>

          <button
            type="button"
            onClick={() => handleSubmit("Completed")}
            style={{
              ...buttonStyle("#007bff"),
              opacity: isFormValid ? 1 : 0.6,
              cursor: isFormValid ? "pointer" : "not-allowed",
            }}
            disabled={!isFormValid}
          >
            Complete
          </button>
        </div>
      </form>

      {/* === FLOATING TOOLTIP === */}
      {hoveredRow && (
        <div
          style={{
            position: "absolute",
            top: tooltipPosition.y,
            left: tooltipPosition.x,
            backgroundColor: "#fff",
            border: "1px solid #ccc",
            borderRadius: "6px",
            padding: "10px",
            boxShadow: "0px 4px 10px rgba(0,0,0,0.15)",
            pointerEvents: "none",
            zIndex: 9999,
            width: "250px",
          }}
        >
          <strong>{hoveredRow.title}</strong>
          <p style={{ margin: "8px 0 0", fontSize: "14px" }}>{hoveredRow.help}</p>
        </div>
      )}
    </div>
  );
};

// ===== Styles =====
const thStyle = { padding: "10px", textAlign: "center", border: "1px solid #ccc", fontWeight: "bold" };
const tdRadioStyle = { textAlign: "center", padding: "10px", borderRight: "1px solid #ddd" };
const buttonStyle = (bgColor) => ({
  padding: "10px 20px",
  backgroundColor: bgColor,
  color: "white",
  border: "none",
  borderRadius: "5px",
  cursor: "pointer",
});

export default CombinedForm;
